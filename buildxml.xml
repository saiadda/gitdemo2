<project name="CSONE_11.3" default="Deploy" basedir="." xmlns:sf="antlib:com.salesforce">

	<property file="build.properties"/>
    <property environment="env"/>

	<target name="Deploy" description="Deploy all changes to other environment">
			<!-- Clean up any previous deployments -->
	        <delete dir="${sf.SourceMetadataFolder}" />
			<delete dir="${sf.ReadyForDeployment}" />
	        <mkdir dir="${sf.SourceMetadataFolder}" />
			<mkdir dir="${sf.ReadyForDeployment}" />
			
			<copy file="${sf.SrcBuildFileFolrder}/package.xml" todir="${sf.SourceMetadataFolder}"/>
			
			<!-- Retrieve user modified components from source org -->
			<sf:retrieve
			        username="${sf.fromusername}"
			        password="${sf.frompassword}"
			        serverurl="${sf.fromserverurl}"
			        retrieveTarget="${sf.SourceMetadataFolder}"
			        unpackaged="${sf.SourceMetadataFolder}/package.xml"
			        maxPoll="1000"
			        pollWaitMillis="10000" />
			
			<copy todir="${sf.ReadyForDeployment}">
	  			<fileset dir="${sf.SourceMetadataFolder}">
	  				<patternset>
		  			    <exclude name="**/**/*.cls"/>
		      	 		<exclude name="**/**/*.cls-meta.xml"/>
		  				<exclude name="**/**/*.trigger"/>
		      	 		<exclude name="**/**/*.trigger-meta.xml"/>
		      	 		<exclude name="**/**/*.page"/>
		      	 		<exclude name="**/**/*.page-meta.xml"/>
		  				<exclude name="**/**/*.resource"/>
		      	 		<exclude name="**/**/*.resource-meta.xml"/> 
		  				<exclude name="**/**/*.component"/>
		      	 		<exclude name="**/**/*.component-meta.xml"/>
					</patternset>
	          	</fileset>
	        </copy>
			<!-- Compare source org and SVN repository. Copy user committed components from SVN to deployment folder -->
			<copy todir="${sf.ReadyForDeployment}" overwrite="true">
	  			<fileset dir="src">
	  			    <include name="**/**/*.cls"/>
		  	 		<include name="**/**/*.cls-meta.xml"/>
					<include name="**/**/*.trigger"/>
		  	 		<include name="**/**/*.trigger-meta.xml"/>
		  	 		<include name="**/**/*.page"/>
		  	 		<include name="**/**/*.page-meta.xml"/>
					<include name="**/**/*.resource"/>
		  	 		<include name="**/**/*.resource-meta.xml"/> 
					<include name="**/**/*.component"/>
		  	 		<include name="**/**/*.component-meta.xml"/>
					<present present="both" targetdir="${sf.SourceMetadataFolder}">
					</present>
	          	</fileset>
	        </copy> 
			<!-- Override package.xml file in  'ReadyForDeployment' folder with the one generated by script automatically -->
			<!-- <copy file="${sf.SrcBuildFileFolrder}/package.xml" tofile="${sf.ReadyForDeployment}/package.xml" overwrite="true"/> -->
			
	      	<!-- Deploy to target org using Force.com ANT deploy task -->
	      	<sf:deploy username="${sf.tousername}" 
	             	password="${sf.topassword}" 
	             	serverurl="${sf.toserverurl}"
	             	deployRoot="${sf.ReadyForDeployment}"
	             	checkOnly="${sf.checkonly}"
	    		 	logType="Detail"
	             	allowMissingFiles="false" 
	             	autoUpdatePackage="false" 
	      			pollWaitMillis="10000"
	      			maxPoll="1000" testLevel="${sf.runTests}"/>
	      	
			<!-- Delete newly created folders -->
			<delete dir="${sf.SourceMetadataFolder}"/>
			<delete dir="${sf.ReadyForDeployment}"/> 
			
	</target>
	
	<target name="Rollback" description="Deploy all changes to other environment">
		<!-- Clean up any previous deployments -->
        <delete dir="${sf.SourceMetadataFolder}" />
		<delete dir="${sf.ReadyForDeployment}" />
        <mkdir dir="${sf.SourceMetadataFolder}" />
		<mkdir dir="${sf.ReadyForDeployment}" />
		
		<copy file="${sf.SrcBuildFileFolrder}/package.xml" todir="${sf.SourceMetadataFolder}"/>
		
		<!-- Retrieve user modified components from source org -->
		<sf:retrieve
		        username="${sf.fromusername}"
		        password="${sf.frompassword}"
		        serverurl="${sf.fromserverurl}"
		        retrieveTarget="${sf.SourceMetadataFolder}"
		        unpackaged="${sf.SourceMetadataFolder}/package.xml"
		        maxPoll="1000"
		        pollWaitMillis="10000" />
		<copy todir="${sf.ReadyForDeployment}">
			  			<fileset dir="${sf.SourceMetadataFolder}">
			  				<patternset>
			  					<exclude name="**/**/Case.object"/>
			  					<exclude name="**/**/Contact.object"/>
							</patternset>
			          	</fileset>
			        </copy>
					<!-- Compare source org and SVN repository. Copy user committed components from SVN to deployment folder -->
					<copy todir="${sf.ReadyForDeployment}" overwrite="true">
			  			<fileset dir="src">
			  				<include name="**/**/Case.object"/>
			  				<include name="**/**/Contact.object"/>
							<present present="both" targetdir="${sf.SourceMetadataFolder}">
							</present>
			          	</fileset>
			        </copy> 
		<!-- Deploy to target org using Force.com ANT deploy task -->
      	<sf:deploy username="${sf.tousername}" 
             	password="${sf.topassword}" 
             	serverurl="${sf.toserverurl}"
             	deployRoot="${sf.ReadyForDeployment}"
             	checkOnly="${sf.checkonly}"
    		 	logType="Detail" 
             	runAllTests="${sf.runalltests}"
             	allowMissingFiles="false" 
             	autoUpdatePackage="false" 
      			pollWaitMillis="10000"
      			maxPoll="1000" />
      	
		<!-- Delete newly created folders -->
		<delete dir="${sf.SourceMetadataFolder}"/>
		<delete dir="${sf.ReadyForDeployment}"/> 
		
    </target>
	<target name="Destroy"> 
		<sf:deploy username="${sf.tousername}" 
	 		password="${sf.topassword}" 
		 	serverurl="${sf.toserverurl}" 
		 	deployroot="Destructive Change Set"
			purgeOnDelete="true"> 
  		</sf:deploy>
	</target>
	<target name="quickDeploy">
		<sf:deployRecentValidation username="${sf.tousername}" password="${sf.topassword}" serverurl="${sf.toserverurl}"
		maxPoll="${sf.maxPoll}" recentValidationId="${sf.recentValidationId}"/>
	</target>
	<target name="cancelDeploy">
		<sf:cancelDeploy username="${sf.username}" password="${sf.password}"
		sessionId="${sf.sessionId}" serverurl="${sf.serverurl}"
		maxPoll="${sf.maxPoll}" requestId="${sf.deployRequestId}"/>
	</target>
	<target name="DeployNew" description="Deploy all changes to other environment">
				<!-- Clean up any previous deployments -->
		        <delete dir="${sf.SourceMetadataFolder}" />
				<delete dir="${sf.ReadyForDeployment}" />
		        <mkdir dir="${sf.SourceMetadataFolder}" />
				<mkdir dir="${sf.ReadyForDeployment}" />
				
				<copy file="${sf.SrcBuildFileFolrder}/package.xml" todir="${sf.SourceMetadataFolder}"/>
				
				<!-- Retrieve user modified components from source org -->
				<sf:retrieve
				        username="${sf.fromusername}"
				        password="${sf.frompassword}"
				        serverurl="${sf.fromserverurl}"
				        retrieveTarget="${sf.SourceMetadataFolder}"
				        unpackaged="${sf.SourceMetadataFolder}/package.xml"
				        maxPoll="1000"
				        pollWaitMillis="10000" />
				
				<copy todir="${sf.ReadyForDeployment}">
		  			<fileset dir="${sf.SourceMetadataFolder}">
		  				<patternset>
			  				<exclude name="**/**/*.cls"/>
			      	 		<exclude name="**/**/*.cls-meta.xml"/>
			  				<exclude name="**/**/*.trigger"/>
			      	 		<exclude name="**/**/*.trigger-meta.xml"/>
			      	 		<exclude name="**/**/*.page"/>
			      	 		<exclude name="**/**/*.page-meta.xml"/>
			  				<exclude name="**/**/*.resource"/>
			      	 		<exclude name="**/**/*.resource-meta.xml"/> 
			  				<exclude name="**/**/*.component"/>
			      	 		<exclude name="**/**/*.component-meta.xml"/>
						</patternset>
		          	</fileset>
		        </copy>
				<!-- Compare source org and SVN repository. Copy user committed components from SVN to deployment folder -->
				<copy todir="${sf.ReadyForDeployment}" overwrite="true">
		  			<fileset dir="src">
		  				<include name="**/**/*.cls"/>
			  	 		<include name="**/**/*.cls-meta.xml"/>
						<include name="**/**/*.trigger"/>
			  	 		<include name="**/**/*.trigger-meta.xml"/>
			  	 		<include name="**/**/*.page"/>
			  	 		<include name="**/**/*.page-meta.xml"/>
						<include name="**/**/*.resource"/>
			  	 		<include name="**/**/*.resource-meta.xml"/> 
						<include name="**/**/*.component"/>
			  	 		<include name="**/**/*.component-meta.xml"/>
						<present present="both" targetdir="${sf.SourceMetadataFolder}">
						</present>
		          	</fileset>
		        </copy> 
				<!-- Override package.xml file in  'ReadyForDeployment' folder with the one generated by script automatically -->
				<!-- <copy file="${sf.SrcBuildFileFolrder}/package.xml" tofile="${sf.ReadyForDeployment}/package.xml" overwrite="true"/> -->
				
		      	<!-- Deploy to target org using Force.com ANT deploy task -->
		      	<sf:deploy username="${sf.tousername}" 
		             	password="${sf.topassword}"
		             	serverurl="${sf.toserverurl}"
		             	deployRoot="${sf.ReadyForDeployment}"
		             	checkOnly="${sf.checkonly}"
		    		 	logType="Detail" 		             	
		             	allowMissingFiles="false" 
		             	autoUpdatePackage="false" 
		      			pollWaitMillis="10000"
		      			maxPoll="1000" testLevel="${sf.runTests}">
		      				<runTest>CSOneAPI_TestCaseSearch</runTest>
		      				<runTest>CSOneAPI_TestCaseUtils</runTest>
		      				<runTest>CSOneAPI_TestCreateCase</runTest>
		      				<runTest>CSOneAPI_TestDeleteDraft</runTest>
		      				<runTest>CSOneAPI_TestDraftCase</runTest>
		      				<runTest>CSOneAPI_TestGetDraftDetail</runTest>
		      				<runTest>Test_CLIPServices_AddLinks</runTest>
		      				<runTest>Test_CS1_CaseEngagementStatus_Handler</runTest>
		      				<runTest>TestCSOneAPI_AddLinks</runTest>
		      				<runTest>TestCSOneAPI_AddNotes</runTest>
		      				<runTest>TestCSOneAPI_CaseStatusUpdate</runTest>
		      				<runTest>TestCSOneAPI_Logger</runTest>
		      				<runTest>TestCSOneAPI_RPInt</runTest>
		      				<runTest>TestCSOneAPI_RPIntUtils</runTest>
		      				<runTest>TestCSOneAPI_UpdateNotes</runTest>
		      				<runTest>TestDMLogLinkageEdit</runTest>
		      				<runTest>TestEntitlementBase</runTest>
		      				<runTest>TestSparkUtilAPI</runTest>
		      				<runTest>TestTaclicensing</runTest>
		      				<runTest>TestUtil_Api</runTest>
		      	</sf:deploy>
		      	
				<!-- Delete newly created folders -->
				<delete dir="${sf.SourceMetadataFolder}"/>
				<delete dir="${sf.ReadyForDeployment}"/> 
				
		</target>
</project>
